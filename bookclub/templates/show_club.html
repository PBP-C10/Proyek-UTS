{% extends 'base.html' %} 

{% block content %}
<body>

    <div style="margin-top: 5px; margin-bottom: 5px;">
        <div class="row">
            <div style="display: flex; align-items: center;">
                <h1 style="margin-right: 10px;">{{ club.name }}</h1>
                <a href="{% url 'book-club:show_main' %}">
                    <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </div>
        <h6>{{ club.description }}</h6>
        <p style="font-size: small;">Created by {{ club.owner }}</p>
        <p style="font-size: small;">Members: {{ club.members.count }}</p>
    </div>
    <hr>

    <h4>Book Recommended By Members</h4>
    <div class="container py-2 border rounded shadow-sm">
        <div class="d-flex flex-row justify-content-between align-items-center">
            <p class="my-auto">Category</p>
            <button class="btn btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCategory" aria-expanded="false" aria-controls="collapseExample">
                <i class="bi bi-caret-down-fill" ></i>
            </button>
        </div>
        <div class="collapse" id="collapseCategory">
            <div class="container my-2" id="categoryContainer">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkboxAdvStories" value="Adventure stories" onchange=searchBookByCategory(this)>
                    <label class="form-check-label" for="flexCheckDefault">
                        Adventure Stories
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkboxArt" value="Art" onchange=searchBookByCategory(this)>
                    <label class="form-check-label" for="flexCheckDefault">
                        Art
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkboxComics" value="Comics & Graphic Novels" onchange=searchBookByCategory(this)>
                    <label class="form-check-label" for="flexCheckDefault">
                        Comics & Graphic Novels
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkboxDetective" value="Detective and mystery stories" onchange=searchBookByCategory(this)>
                    <label class="form-check-label" for="flexCheckDefault">
                        Detective and Mystery Stories
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkboxDrama" value="Drama" onchange=searchBookByCategory(this)>
                    <label class="form-check-label" for="flexCheckDefault">
                        Drama
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkboxFantasy" value="Fantasy fiction" onchange=searchBookByCategory(this)>
                    <label class="form-check-label" for="flexCheckDefault">
                        Fantasy Fiction
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkboxHistory" value="History" onchange=searchBookByCategory(this)>
                    <label class="form-check-label" for="flexCheckDefault">
                        History
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkboxJuvenile" value="Juvenile Fiction" onchange=searchBookByCategory(this)>
                    <label class="form-check-label" for="flexCheckDefault">
                        Juvenile Fiction
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkboxScience" value="Science fiction" onchange=searchBookByCategory(this)>
                    <label class="form-check-label" for="flexCheckDefault">
                        Science Fiction
                    </label>
                </div>       
            </div>
        </div>
    </div>

    <br>

    <div class="row">
        <div id="book_card" data-id="{{ club.pk }}">
    </div>

    <br>

    <form method="post" action="{% url 'book-club:add_rec_book' club.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">Add Book Recommendation</button>
    </form>

    <br>

    <div class="card-deck">
        <div id="bubble_card">
        {% for bubble in bubbles %}
        <div class="card border-primary mb-3">
            <div class="card-header">
                <p style="font-weight: bold; margin-top: 10px;" class="card-title">{{ bubble.user.username }}</p>
                <p style="font-size: xx-small;">Posted on {{ bubble.timestamp }}</p>
            </div>
            <div class="card-body">
                <p class="card-text">{{ bubble.content }}</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="text-center mt-3">
        <button id="createBubbleButton" type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#postBubbleModal">Post Your Thoughts</button>
    </div>

    <div class="modal fade" id="postBubbleModal" tabindex="-1" aria-labelledby="postBubbleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="color: black;">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" style="color: black;" id="postBubbleModalLabel">Post Your Thoughts</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
    
                <div class="modal-body">
                    <form id="form" onsubmit="return false">                            
                        {% csrf_token %}
                        <div class="mb-3" style="font-size: medium;">
                            {{ bubble_form.content }}
                        </div>
    
                        <div class="modal-footer" style="justify-content: center;">
                            <button id="postBubbleButton" type="submit" value="Submit" class="btn btn-outline-success" data-bs-dismiss="modal">Post</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</body>

<script>   
    let category =[];

    async function getRecommendedBooks(clubId) {
        const recommendedBooksURL = "{% url 'book-club:get_recommended_book_json' 0 %}".replace("0", clubId);
        return fetch(recommendedBooksURL).then((res) => res.json())
    }
    
    async function getBubbles(clubId) {
        const bubbleURL = "{% url 'book-club:get_bubble_json' 0 %}".replace("0", clubId);
        return fetch(bubbleURL).then((res) => res.json())
    }

    function searchBookByCategory(checkbox){
        if (checkbox.checked){
            category.push(checkbox.value)
        } else {
            let indexArr = category.indexOf(checkbox.value)
            if (indexArr != -1){
                category.splice(indexArr, 1)
            }
            page = "1"
        }

        let card = document.getElementById("book_card")
        let clubId = card.getAttribute("data-id")

        loadRecommendedBooks(clubId, category)
    }
    
    async function loadRecommendedBooks(clubId, category) {
        let cardHtml = ''
        document.getElementById("book_card").innerHTML = cardHtml
        const recommendedBooks = await getRecommendedBooks(clubId);

        for (const book of recommendedBooks) {
            if (book.fields.category == category || category.length == 0) {
                cardHtml += `
                    <div class="col-2 col-sm-2 col-md-2 col-lg-1 col-xl-1 mb-2">
                        <div class="card border-primary h-100" style="width: 100%;">
                            <img src="${book.fields.thumbnail}" class="card-img-top" alt="${book.fields.title}" style="width: 100%; height: auto;">
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title" style="font-weight: bold;">${book.fields.title}</h6>
                            </div>
                        </div>
                    </div>
                `;
            }
        };
        
        document.getElementById("book_card").innerHTML = `<div class="card-container" style="display: flex; flex-wrap: wrap; justify-content: space-between;">${cardHtml}</div>`;
        category = [];
    }

    async function loadBubbles(clubId) {
        let cardHtml = ''
        document.getElementById("bubble_card").innerHTML = cardHtml
        const bubbles = await getBubbles(clubId);
        console.log(bubbles)

        for (const bubble of bubbles) {
            cardHtml += `
            <div class="card border-primary mb-3">
                <div class="card-header">
                    <p style="font-weight: bold; margin-top: 10px;" class="card-title">${bubble.fields.user.username}</p>
                    <p style="font-size: xx-small;">Posted on ${bubble.fields.timestamp}</p>
                </div>
                <div class="card-body">
                    <p class="card-text">${bubble.fields.content}</p>
                </div>
            </div>
            `;
        }

        document.getElementById("bubble_card").innerHTML = `<div class="card-container" style="display: flex; flex-wrap: wrap; justify-content: space-between;">${cardHtml}</div>`;
    }

    function postBubble(clubId) {
        console.log("halo")
        const postBubbleURL = "{% url 'book-club:post_bubble' 0 %}".replace("0", clubId);
        fetch(postBubbleURL, {
            method: "POST",
            body: new FormData(document.querySelector('#form')),
        }).then((response) => {
            console.log("halo2")
            loadBubbles(clubId);
            document.getElementById("form").reset();
        });
    }

    let card = document.getElementById("book_card")
    let clubId = card.getAttribute("data-id")

    loadRecommendedBooks(clubId, [])
    loadBubbles(clubId)

    document.getElementById("postBubbleButton").onclick = (()=>{postBubble(clubId)})

</script>

{% endblock %}