{% extends 'base.html' %}

{% block content %}
<div class="container-fluid d-flex">
    <div class="m-1 container w-25">
        <h4>Filter</h4>
        <div class="container p-2 border rounded shadow-sm">
            <div class="d-flex flex-row justify-content-between align-items-center">
                <h5>Category</h5>
                <button class="btn btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCategory" aria-expanded="false" aria-controls="collapseExample">
                    <i class="bi bi-caret-down-fill" ></i>
                </button>
            </div>
            <div class="collapse" id="collapseCategory">
                <div class="container my-2" id="categoryContainer">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkboxAdvStories" value="Adventure stories" onchange=searchBookByCategory(this)>
                        <label class="form-check-label" for="flexCheckDefault">
                            Adventure Stories
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkboxArt" value="Art" onchange=searchBookByCategory(this)>
                        <label class="form-check-label" for="flexCheckDefault">
                            Art
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkboxComics" value="Comics & Graphic Novels" onchange=searchBookByCategory(this)>
                        <label class="form-check-label" for="flexCheckDefault">
                            Comics & Graphic Novels
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkboxDetective" value="Detective and mystery stories" onchange=searchBookByCategory(this)>
                        <label class="form-check-label" for="flexCheckDefault">
                            Detective and Mystery Stories
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkboxDrama" value="Drama" onchange=searchBookByCategory(this)>
                        <label class="form-check-label" for="flexCheckDefault">
                            Drama
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkboxFantasy" value="Fantasy fiction" onchange=searchBookByCategory(this)>
                        <label class="form-check-label" for="flexCheckDefault">
                            Fantasy Fiction
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkboxHistory" value="History" onchange=searchBookByCategory(this)>
                        <label class="form-check-label" for="flexCheckDefault">
                            History
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkboxJuvenile" value="Juvenile Fiction" onchange=searchBookByCategory(this)>
                        <label class="form-check-label" for="flexCheckDefault">
                            Juvenile Fiction
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkboxScience" value="Science fiction" onchange=searchBookByCategory(this)>
                        <label class="form-check-label" for="flexCheckDefault">
                            Science Fiction
                        </label>
                    </div>
                    
                </div>
            </div>
            <hr class="hr m-1">
            <div class="d-flex flex-row justify-content-between align-items-center">
                <h5>Price</h5>
                <button class="btn btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrice" aria-expanded="false" aria-controls="collapseExample">
                    <i class="bi bi-caret-down-fill" ></i>
                </button>
            </div>  
            <div class="collapse" id="collapsePrice">
                <div class="container my-2" id="priceContainer">
                    <div class="input-group mb-3">
                        <span class="input-group-text">Rp</span>
                        <input type="number" class="form-control" placeholder="Min Price" oninput=filterHarga() id="minPriceBox" min="0" max="500000">
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Rp</span>
                        <input type="number" class="form-control" placeholder="Max Price" oninput=filterHarga() id="maxPriceBox" min="0" max="500000">
                    </div>
                </div>
            </div>
            <hr class="hr m-1">
            <div class="d-flex flex-row justify-content-between align-items-center">
                <h5>Rating</h5>
                <button class="btn btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRating" aria-expanded="false" aria-controls="collapseExample">
                    <i class="bi bi-caret-down-fill" ></i>
                </button>
            </div> 
            <div class="collapse" id="collapseRating">
                <div class="container my-2 d-flex flex-column" id="ratingContainer">

                    <input type="radio" class="btn-check" name="options" id="star2" autocomplete="off" onchange=filterRating(this) value="4">
                    <label class="btn" for="star2">
                        <i class="bi bi-star-fill"></i> <i class="bi bi-star-fill"></i> <i class="bi bi-star-fill"></i> <i class="bi bi-star-fill"></i> <i class="bi bi-star"></i> and up
                    </label>

                    <input type="radio" class="btn-check" name="options" id="star3" autocomplete="off" onchange=filterRating(this) value="3">
                    <label class="btn" for="star3">
                        <i class="bi bi-star-fill"></i> <i class="bi bi-star-fill"></i> <i class="bi bi-star-fill"></i> <i class="bi bi-star"></i> <i class="bi bi-star"></i> and up
                    </label>

                    <input type="radio" class="btn-check" name="options" id="star4" autocomplete="off" onchange=filterRating(this) value="2">
                    <label class="btn" for="star4">
                        <i class="bi bi-star-fill"></i> <i class="bi bi-star-fill"></i> <i class="bi bi-star"></i> <i class="bi bi-star"></i> <i class="bi bi-star"></i> and up
                    </label>

                    <input type="radio" class="btn-check" name="options" id="star5" autocomplete="off" onchange=filterRating(this) value="1">
                    <label class="btn" for="star5">
                        <i class="bi bi-star-fill"></i> <i class="bi bi-star"></i> <i class="bi bi-star"></i> <i class="bi bi-star"></i> <i class="bi bi-star"></i> and up
                    </label>

                    <input type="radio" class="btn-check" name="options" id="clearRating" autocomplete="off" onchange=filterRating(this) value="0">
                    <label class="btn" for="clearRating">
                        No Filter
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <form class="d-flex rounded border">
            <input class="form-control" type="text" placeholder="Search Books and Authors" aria-label="Search" id="search" oninput=searchBook()>
        </form>

        <div id="book_cards" class="my-3">

        </div>
        <nav>
            <ul class="pagination justify-content-center" id="page">
                
            </ul>
        </nav>
    </div>
</div>



<script>
    async function getBooks(cat, filter, page, minPrice, maxPrice, minRating) {
        let url = new URL("get-books", window.location)
        let param = new URLSearchParams(url.search)
        param.set("page", page)
        if (category.length != 0){
            param.append('category', category)
        }
        if (filter != ""){
            param.append("filter", filter)
        }
        if (minPrice != 0){
            param.append("minPrice", minPrice)
        }
        if (maxPrice <= 500000){
            param.append("maxPrice", maxPrice)
        }
        if (minRating > 0){
            param.append("minRating", minRating)
        }
        url = new URL(url.href + "/?" + param)
        console.log(url.href)
        return fetch(url).then((res) => res.json())
    }

    async function refreshPage(category, filter, page, minPrice, maxPrice, minRating) {
        const booksData = await getBooks(category, filter, page, minPrice, maxPrice, minRating)
        let bookCardString = '<div class="row row-cols-1 row-cols-md-5">'
        let pageString = '<ul class="pagination">'
        books = JSON.parse(booksData.books)
        books.forEach((book) => {
            book.fields.ratings_count = book.fields.ratings_count > 1000 ? Math.floor(book.fields.ratings_count / 1000) + "k+" : book.fields.ratings_count

            bookCardString += 
                `<div class="col my-2 ">
                    <div class="card shadow rounded h-100">
                        <div class="card-header">
                            <img src="${book.fields.thumbnail}" width="250" height="250" alt="" class="card-img-top" loading="lazy">
                        </div>
                        <div class="card-body d-flex flex-column w-75">
                            <h5 class="card-title">${book.fields.title}</h5>
                            <h6 class="card-subtitle mb-2 text-truncate">${book.fields.subtitle}</h6>
                            <h6 class="card-subtitle mb-2 text-muted text-truncate">${book.fields.author}</h6>
                            <h6 class="card-subtitle mb-2">Rp ${book.fields.price}</h6>
                            <h6 class="card-subtitle mb-2"><i class="bi bi-star-fill"></i> ${book.fields.average_rating}</h6> 
                            <h6 class="card-subtitle mb-2">${book.fields.ratings_count} ratings</h6>
                        </div>
                    </div>
                </div>`
        })

        totalPageNum = JSON.parse(booksData.total_page_num)
        currentPage = JSON.parse(booksData.current_page)
        hasNext = JSON.parse(booksData.has_next)
        nextPage = JSON.parse(booksData.next_page)
        prevPage = JSON.parse(booksData.prev_page)
        hasPrev = JSON.parse(booksData.has_previous)
        
        for (let i = 0; i <= totalPageNum + 1; i++){
            if (i == 0){
                if (hasPrev){
                    pageString += `<li class="page-item"><a class="page-link" onclick=goToPage(${prevPage})>Previous</a></li>`
                } else {
                    pageString += `<li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>`
                }
            } else if (i == totalPageNum + 1){
                if (hasNext){
                    pageString += `<li class="page-item"><a class="page-link" onclick=goToPage(${nextPage}) >Next</a></li>`
                } else {
                    pageString += `<li class="page-item disabled"><a class="page-link" href="#">Next</a></li>`
                }
            } else if (i == currentPage){
                pageString += `<li class="page-item active"><a class="page-link active" href="#">${i}</a></li>`
            } else {
                pageString += `<li class="page-item"><a class="page-link" onclick=goToPage(${i})>${i}</a></li>`
            }
        }
    
        
        bookCardString += '\n</div>'
        pageString += `\n</ul>`
        
        document.getElementById("book_cards").innerHTML = bookCardString
        document.getElementById("page").innerHTML = pageString
    }

    let filter = document.getElementById("search").value
    let category = []
    let page = "1"
    let minPrice = 0
    let maxPrice = 500000
    let minRating = 0

    refreshPage(category, filter, page, minPrice, maxPrice, minRating)

    function goToPage(newPage){
        page = newPage
        refreshPage(category, filter, page, minPrice, maxPrice, minRating)
        window.scrollTo(0,0)
    }

    function searchBook(){
        filter = document.getElementById("search").value
        refreshPage(category, filter, page, minPrice, maxPrice)
    }

    function searchBookByCategory(checkbox){
        filter = document.getElementById("search").value
        if (checkbox.checked){
            category.push(checkbox.value)
        } else {
            let indexArr = category.indexOf(checkbox.value)
            if (indexArr != -1){
                category.splice(indexArr, 1)
            }
            page = "1"
        }
        refreshPage(category,filter,page, minPrice, maxPrice, minRating)
    }

    function filterHarga(){
        filter = document.getElementById("search").value
        minPrice = document.getElementById("minPriceBox").value
        maxPrice = document.getElementById("maxPriceBox").value
        refreshPage(category,filter,page,minPrice,maxPrice, minRating)
    }

    function filterRating(radio){
        filter = document.getElementById("search").value
        if (radio.checked){
            minRating = parseInt(radio.value)
        } else {
            radio.checked = false
            minRating = 0
        }
        page = "1"
        refreshPage(category,filter,page,minPrice,maxPrice, minRating)
    }

</script>
{% endblock content %}